<!doctype html>
<!--
Copyright 2020 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Sample illustrating the use of Service Worker Sample: Custom Offline Page.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Service Worker Sample: Custom Offline Page Sample</title>
  <script>
    // Add a global error event listener early on in the page load, to help ensure that browsers
    // which don't support specific functionality still end up displaying a meaningful message.
    window.addEventListener('error', function(error) {
      if (ChromeSamples && ChromeSamples.setStatus) {
        console.error(error);
        ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
        error.preventDefault();
      }
    });
  </script>




  <link rel="icon" href="../../images/favicon.ico">

  <link rel="stylesheet" href="../../styles/main.css">


</head>

<body>

  <h1>Service Worker Sample: Custom Offline Page Sample</h1>
  <p class="availability">
    Available in <a target="_blank" href="https://www.chromestatus.com/feature/6561526227927040">Chrome 40+</a> |
    <a target="_blank" href="https://github.com/googlechrome/samples/blob/gh-pages/service-worker/custom-offline-page/">View on GitHub</a> |
    <a target="_blank" href="https://www.chromestatus.com/samples">Browse Samples</a>
  </p>
  <h3>Background</h3>
  <p>
    This sample demonstrates basic service worker registration. During the installation step, a
    custom "Sorry, you're offline." page is cached. The service worker handles all fetch requests
    for HTML pages (ignoring other requests), and if fetching an HTML page fails due to a network
    error, it will instead return the cached "offline" page.
  </p>

  <p>
    Try disconnecting from your network, and then reload this page.
  </p>




  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>




  <h3>This Page's JavaScript</h3>



  <figure class="highlight">
    <pre><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="dl">'</span><span class="s1">serviceWorker</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">'</span><span class="s1">service-worker.js</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span></code></pre>
  </figure>







  <h3>Service Worker's JavaScript</h3>



  <figure class="highlight">
    <pre><code class="language-js" data-lang="js"><span class="cm">/*
Copyright 2015, 2019 Google Inc. All Rights Reserved.
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/</span>

<span class="c1">// Incrementing OFFLINE_VERSION will kick off the install event and force</span>
<span class="c1">// previously cached resources to be updated from the network.</span>
<span class="kd">const</span> <span class="nx">OFFLINE_VERSION</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">CACHE_NAME</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">offline</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// Customize this with a different URL if needed.</span>
<span class="kd">const</span> <span class="nx">OFFLINE_URL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">offline.html</span><span class="dl">'</span><span class="p">;</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">install</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">((</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">);</span>
    <span class="c1">// Setting {cache: 'reload'} in the new request will ensure that the response</span>
    <span class="c1">// isn't fulfilled from the HTTP cache; i.e., it will be from the network.</span>
    <span class="k">await</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">OFFLINE_URL</span><span class="p">,</span> <span class="p">{</span><span class="na">cache</span><span class="p">:</span> <span class="dl">'</span><span class="s1">reload</span><span class="dl">'</span><span class="p">}));</span>
  <span class="p">})());</span>
<span class="p">});</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">activate</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">((</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Enable navigation preload if it's supported.</span>
    <span class="c1">// See https://developers.google.com/web/updates/2017/02/navigation-preload</span>
    <span class="k">if</span> <span class="p">(</span><span class="dl">'</span><span class="s1">navigationPreload</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">self</span><span class="p">.</span><span class="nx">registration</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nb">self</span><span class="p">.</span><span class="nx">registration</span><span class="p">.</span><span class="nx">navigationPreload</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">})());</span>

  <span class="c1">// Tell the active service worker to take control of the page immediately.</span>
  <span class="nb">self</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">claim</span><span class="p">();</span>
<span class="p">});</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// We only want to call event.respondWith() if this is a navigation request</span>
  <span class="c1">// for an HTML page.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">navigate</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">((</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// First, try to use the navigation preload response if it's supported.</span>
        <span class="kd">const</span> <span class="nx">preloadResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">event</span><span class="p">.</span><span class="nx">preloadResponse</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">preloadResponse</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">preloadResponse</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">networkResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">networkResponse</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// catch is only triggered if an exception is thrown, which is likely</span>
        <span class="c1">// due to a network error.</span>
        <span class="c1">// If fetch() returns a valid HTTP response with a response code in</span>
        <span class="c1">// the 4xx or 5xx range, the catch() will NOT be called.</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Fetch failed; returning offline page instead.</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

        <span class="kd">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">cachedResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">OFFLINE_URL</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">cachedResponse</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">})());</span>
  <span class="p">}</span>

  <span class="c1">// If our if() condition is false, then this fetch handler won't intercept the</span>
  <span class="c1">// request. If there are any other fetch handlers registered, they will get a</span>
  <span class="c1">// chance to call event.respondWith(). If no fetch handlers call</span>
  <span class="c1">// event.respondWith(), the request will be handled by the browser as if there</span>
  <span class="c1">// were no service worker involvement.</span>
<span class="p">});</span></code></pre>
  </figure>
</body>

</html>
